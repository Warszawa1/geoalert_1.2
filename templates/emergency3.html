<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Alert</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Emergency Alert</h1>
        
        <div id="loading">
            <div class="loader"></div>
            <div id="loading-message">Loading emergency information...</div>
        </div>
        <div id="emergency-message" class="mt-4" style="display: none;"></div>
        <div id="map" class="mt-4" style="display: none; height: 200px;"></div>
        {% if user.is_diabetic and user.uses_dexcom %}
        <div class="mt-6">
            <h3>Recent Glucose Readings</h3>
            <div id="current-glucose-emergency" class="text-2xl font-bold mb-2"></div>
            <div style="width: 100%; max-width: 500px; height: 200px;">
                <canvas id="glucose-chart-emergency"></canvas>
            </div>
        </div>
        {% endif %}

        <div id="emergency-info"></div>
        <div id="glucose-info" style="display: none;">
            <h2>Recent Glucose Readings</h2>
            <div id="current-glucose" class="text-2xl font-bold mb-2"></div>
            <div class="chart-container">
                <canvas id="glucose-chart"></canvas>
            </div>
        </div>


        <div id="glucose-data" class="mt-4" style="display: none;">
            <h2 class="text-2xl font-bold mb-2">Glucose Readings:</h2>
            <pre id="glucose-readings" class="bg-white p-4 rounded shadow"></pre>
        </div>
        <div id="status" class="mt-4"></div>
        <div id="alert-status" class="mt-4"></div>
        <div id="error" class="mt-4 text-red-500"></div>
    </div>

    <script>
        let map, marker;
        let userLat, userLon;
    
        function initMap(lat, lon) {
            map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([lat, lon]).addTo(map);
        }
    
        function displayGlucoseData(glucoseData) {
            if (!glucoseData || glucoseData.length === 0) {
                console.log('No glucose data available');
                document.getElementById('glucose-data').style.display = 'none';
                return;
            }
    
            document.getElementById('glucose-data').style.display = 'block';
            const glucoseReadings = document.getElementById('glucose-readings');
            glucoseReadings.textContent = JSON.stringify(glucoseData, null, 2);
        }
    
        // function getEmergencyInfo(lat, lon) {
        //     const urlParams = new URLSearchParams(window.location.search);
        //     const username = urlParams.get('username');
    
        //     fetch('/get_emergency_info', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //         },
        //         body: JSON.stringify({ latitude: lat, longitude: lon, username: username }),
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log('Emergency info response:', data);  // Log the entire response
        //         if (data.status === "success") {
        //             document.getElementById('loading').style.display = 'none';
        //             document.getElementById('map').style.display = 'block';
        //             document.getElementById('emergency-message').style.display = 'block';
        //             displayEmergencyMessage(data.translations);
        //             initMap(data.latitude, data.longitude);
                    
        //             if (data.glucose_readings && data.glucose_readings.length > 0) {
        //                 displayGlucoseData(data.glucose_readings);
        //             } else {
        //                 console.log('No glucose readings in main response, fetching from Dexcom API');
        //                 fetchDexcomData(username);
        //             }
                    
        //             document.getElementById('status').textContent = "Emergency information loaded.";
        //             document.getElementById('alert-status').textContent = data.alert_sent ? 
        //                 "Alert sent successfully to emergency contacts." : 
        //                 "Failed to send alert to emergency contacts.";
        //         } else {
        //             throw new Error(data.message || "Unknown error occurred");
        //         }
        //     })
        //     .catch(error => {
        //         document.getElementById('loading').style.display = 'none';
        //         document.getElementById('status').textContent = "Error loading information.";
        //         document.getElementById('error').textContent = "Error details: " + error.message;
        //         console.error('Error:', error);
        //     });
        // }

        document.addEventListener('DOMContentLoaded', function() {
        function getEmergencyInfo(lat, lon) {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');

            fetch('/get_emergency_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username: username, latitude: lat, longitude: lon }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    displayEmergencyInfo(data);
                    if (data.glucose_readings) {
                        displayGlucoseInfo(data.glucose_readings);
                    }
                } else {
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function displayEmergencyInfo(data) {
            const infoDiv = document.getElementById('emergency-info');
            let html = '<h2>Emergency Message:</h2>';
            for (const [lang, message] of Object.entries(data.translations)) {
                html += `<p><strong>${lang}:</strong> ${message}</p>`;
            }
            html += `<p>Location: ${data.latitude}, ${data.longitude}</p>`;
            infoDiv.innerHTML = html;
        }

        function displayGlucoseInfo(readings) {
            const glucoseInfo = document.getElementById('glucose-info');
            const currentGlucose = document.getElementById('current-glucose');
            const chartElement = document.getElementById('glucose-chart');
            
            glucoseInfo.style.display = 'block';
            
            if (readings.length > 0) {
                const latestReading = readings[readings.length - 1];
                currentGlucose.textContent = `Current: ${latestReading.value} mg/dL`;

                const chartData = readings.map(reading => ({
                    x: new Date(reading.time),
                    y: reading.value
                }));

                new Chart(chartElement, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Glucose Level (mg/dL)',
                            data: chartData,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour' },
                                title: { display: true, text: 'Time' }
                            },
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: 'mg/dL' }
                            }
                        }
                    }
                });
            }
        }

        // Get user's location and fetch emergency info
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                getEmergencyInfo(position.coords.latitude, position.coords.longitude);
            }, function(error) {
                console.error("Error getting location:", error);
            });
        } else {
            console.error("Geolocation is not supported by this browser.");
        }
    });


        function fetchDexcomData(username) {
            console.log('Attempting to fetch Dexcom data for username:', username);
            
            fetch(`/api/dexcom-data?username=${encodeURIComponent(username)}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received Dexcom API response:', data);
                if (data.success && data.readings && data.readings.length > 0) {
                    displayGlucoseData(data.readings);
                } else {
                    document.getElementById('glucose-data').style.display = 'none';
                    console.log('No glucose readings available');
                    if (data.error) {
                        console.error('Dexcom data error:', data.error);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching Dexcom data:', error);
                document.getElementById('glucose-data').style.display = 'none';
            });
        }
    
        function displayEmergencyMessage(translations) {
            const messageDiv = document.getElementById('emergency-message');
            messageDiv.innerHTML = '<h2 class="text-xl font-bold mb-2">Emergency Message:</h2>';
            for (const [lang, translation] of Object.entries(translations)) {
                messageDiv.innerHTML += `
                    <div class="bg-white shadow-md rounded px-4 py-2 mb-2">
                        <h3 class="font-bold">${getLanguageName(lang)}:</h3>
                        <p>${translation}</p>
                    </div>
                `;
            }
        }
    
        function getLanguageName(langCode) {
            const languageNames = {
                'en': 'English', 'es': 'Español', 'nl': 'Nederlands',
                'fr': 'Français', 'de': 'Deutsch', 'it': 'Italiano', 'pl': 'Polski'
            };
            return languageNames[langCode] || langCode.toUpperCase();
        }
    
        function getLocationAndProcess() {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
    
            if (!username) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = "No username provided. Please use a valid emergency link.";
                return;
            }
    
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    getEmergencyInfo(userLat, userLon);
                }, function(error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('status').textContent = "Unable to get location.";
                    document.getElementById('error').textContent = "Geolocation error: " + error.message;
                    console.error('Geolocation Error:', error);
                });
            } else {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').textContent = "Geolocation not supported.";
                document.getElementById('error').textContent = "Please contact emergency services directly.";
            }
        }
    
        // Start the process when the page loads
        window.onload = getLocationAndProcess;
    </script>
</body>
</html>