<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Alert</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
    .loader {
    border: 8px solid #f3f3f3; /* Slightly thicker border */
    border-top: 8px solid #3498db; /* Thicker top border for better visibility */
    border-radius: 50%;
    width: 120px; /* Larger width */
    height: 120px; /* Larger height */
    animation: spin 1s linear infinite;
    margin: 20px auto;
    box-shadow: 0 0 15px rgba(52, 152, 219, 0.5); /* Add a subtle shadow */
}

/* Keyframes for spin animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive styles */
@media (max-width: 768px) {
    .loader {
        width: 80px; /* Smaller width for smaller screens */
        height: 80px; /* Smaller height for smaller screens */
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
    }
    #chart-container {
        margin-top: 10px;
    }
}

@media (max-width: 480px) {
    .loader {
        width: 60px; /* Even smaller width for very small screens */
        height: 60px; /* Even smaller height for very small screens */
        border: 4px solid #f3f3f3;
        border-top: 4px solid #60A5FA;
    }
}

@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.25); }
    }
    .pulse-animation {
        animation: pulse 2s infinite;
    }

#loading-message {
    font-size: 18px;
    margin-top: 10px;
}

</style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <main class="max-w-7xl mx-auto pb-10 lg:py-12 lg:px-8">
            <div class="lg:grid lg:grid-cols-12 lg:gap-x-5">
                <div class="space-y-6 sm:px-6 lg:px-0 lg:col-span-12">
                    <div class="shadow sm:rounded-md sm:overflow-hidden">
                            <div class="p-4 mb-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <svg class="h-10 w-10 mr-4 pulse-animation" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="12" r="10" stroke="#60A5FA" stroke-width="3" fill="#EFF6FF"/>
                                            <path d="M12 8V12" stroke="#2563EB" stroke-width="3" stroke-linecap="round"/>
                                            <circle cx="12" cy="16" r="1.25" fill="#2563EB"/>
                                        </svg>
                                        <h1 class="text-xl font-semibold text-gray-800">Emergency Alert System</h1>
                                    </div>
                                </div>
                            </div>
                            

                            <div id="loading" class="text-center">
                                <div class="loader border-t-4 border-blue-500 rounded-full border-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
                                <div id="loading-message" class="text-lg text-gray-600">Loading emergency information...</div>
                            </div>

                            <div id="emergency-message" class="mt-6">
                                <!-- Emergency message content will be inserted here -->
                            </div>

                            <div id="glucose-section" class="bg-white shadow overflow-hidden sm:rounded-lg">
                                <div class="px-4 py-5 sm:px-6">
                                    <h2 class="text-lg leading-6 font-medium text-gray-900">Glucose Information</h2>
                                </div>

                                <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                                    <dl class="sm:divide-y sm:divide-gray-200">
                                        <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                            <dt class="text-sm font-medium text-gray-500">Current Glucose</dt>
                                            <dd id="current-glucose" class="mt-1 text-3xl font-semibold text-green-600 sm:mt-0 sm:col-span-2">155 mg/dL</dd>
                                        </div>
                                    </dl>
                                </div>
                                <div class="px-4 py-5 sm:p-6">
                                    {% if user.is_diabetic and user.uses_dexcom %}
                                        {% if dexcom_readings | reverse %}
                                            <div id="glucose-data" data-readings="{{ dexcom_readings | tojson | forceescape }}"></div>
                                        {% else %}
                                            <p>No recent Dexcom readings available.</p>
                                        {% endif %}
                                    {% else %}
                                        <p>Dexcom integration is not enabled for this user.</p>
                                    {% endif %}
                                    <canvas id="glucoseChart" class="w-full h-64"></canvas>
                                </div>
                            </div>

                            <div id="map" class="h-64 sm:h-96 rounded-lg shadow-inner"></div>
                            <div id="status" class="mt-4 text-sm text-gray-600"></div>
                            <div id="alert-status" class="mt-4 text-green-600" style="font-size: 0.9375rem;""></div>
                            <div id="error" class="mt-4 text-red-500"></div>

                        </div>
                    </div>
                </div>
            </div>
        </main>
        
    </div>

    
        <div id="language-flags" class="flex space-x-2"></div>
    
        <div id="glucose-info" class="bg-white p-4 rounded-lg shadow hidden">
            <h2 class="text-xl font-semibold mb-2">Glucose Information</h2>
            <p id="glucose-reading" class="text-gray-700"></p>
        </div>
    
        <div id="alert-status" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 hidden" role="alert">
            <p class="font-bold">Alert Status</p>
            <p>Emergency alert has been sent successfully.</p>
        </div>
    </div>

    <footer class="bg-white">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <p class="text-center text-sm text-gray-500">
                Made with <span class="text-blue-500 pulse-animation inline-block">♥</span> 
                <br>© 2024 IreAV. All rights reserved.
            </p>
        </div>
    </footer>


    <script>
        let map, marker;
        let userLat, userLon;

        function initMap(lat, lon) {
            map = L.map('map').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([lat, lon]).addTo(map);
        }

        function getEmergencyInfo(lat, lon) {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');

            fetch('/get_emergency_info', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ latitude: lat, longitude: lon, username: username }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('map').style.display = 'block';
                    document.getElementById('emergency-message').style.display = 'block';
                    displayEmergencyMessage(data.translations);
                    initMap(data.latitude, data.longitude);
                    document.getElementById('status').textContent = " ☑️ Emergency information loaded.";
                    document.getElementById('alert-status').textContent = data.alert_sent ? 
                        " ☑️ Alert sent successfully to emergency contacts." : 
                        "❗️Failed to send alert to emergency contacts.";
                    

                    // After displaying emergency info, start loading glucose data
                    document.getElementById('glucose-section').style.display = 'block';
                    setTimeout(() => fetchDexcomData(username), 1000); // Delay glucose data fetch by 1 second
                } else {
                    throw new Error(data.message || "Unknown error occurred");
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').textContent = "Error loading information.";
                document.getElementById('error').textContent = "Error details: " + error.message;
                // console.error('Error:', error);
            });
        }

        function displayEmergencyMessage(translations) {
            const messageDiv = document.getElementById('emergency-message');
            messageDiv.innerHTML = '<h2 class="text-xl text-center mb-2">    Message:</h2>';
            for (const [lang, translation] of Object.entries(translations)) {
                messageDiv.innerHTML += `
                    <div class="bg-white shadow-md rounded px-4 py-2 mb-2">
                        <h3 class="font-bold">${getLanguageName(lang)}:</h3>
                        <p>${translation}</p>
                    </div>
                `;
            }
        }

        function getLanguageName(langCode) {
            const languageNames = {
                'en': 'English', 'es': 'Español', 'nl': 'Nederlands',
                'fr': 'Français', 'de': 'Deutsch', 'it': 'Italiano', 'pl': 'Polski'
            };
            return languageNames[langCode] || langCode.toUpperCase();
        }

        function getLocationAndProcess() {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');

            if (!username) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = "No username provided. Please use a valid emergency link.";
                return;
            }

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    getEmergencyInfo(userLat, userLon);
                }, function(error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('status').textContent = "Unable to get location.";
                    document.getElementById('error').textContent = "Geolocation error: " + error.message;
                    console.error('Geolocation Error:', error);
                });
            } else {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').textContent = "Geolocation not supported.";
                document.getElementById('error').textContent = "Please contact emergency services directly.";
            }
        }

        function getColor(value) {
            if (value <= 70) return '#F44336'; //complementary to the green
            if (value <= 180) return 'rgba(5, 150, 105)'; // vibrant green but easy on the eyes
            return 'orange';
        }

        function updateChart(glucoseReadings) {
            console.log("Glucose Readings:", glucoseReadings);  // Log the readings for debugging

            if (!Array.isArray(glucoseReadings) || glucoseReadings.length === 0) {
                console.error("Invalid or empty glucose readings data");
                return;
            }

            const ctx = document.getElementById('glucoseChart').getContext('2d');
            const currentGlucose = document.getElementById('current-glucose');
            
            // Update current glucose display
            const latestReading = glucoseReadings[0];
            if (latestReading && typeof latestReading.value !== 'undefined') {
                currentGlucose.textContent = `${latestReading.value} mg/dL`;
                currentGlucose.style.color = getColor(latestReading.value);
            } else {
                console.error("Latest reading is invalid:", latestReading);
                currentGlucose.textContent = "N/A";
            }

            // Prepare data for the chart
            const chartData = {
                labels: [],
                datasets: [{
                    label: 'GLUCOSE LEVEL (mg/dL)',
                    data: [],
                    borderColor: [],
                    tension: 0.2,
                    fill: true
                }]
            };

            glucoseReadings.forEach((reading, index) => {
                if (reading && typeof reading.time !== 'undefined' && typeof reading.value !== 'undefined') {
                    chartData.labels.push(new Date(reading.time));
                    chartData.datasets[0].data.push({
                        x: new Date(reading.time),
                        y: reading.value
                    });
                    chartData.datasets[0].borderColor.push(getColor(reading.value));
                } else {
                    console.error(`Invalid reading at index ${index}:`, reading);
                }
            });

            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Glucose Level (mg/dL)'
                            },
                            suggestedMin: 30,
                            suggestedMax: 350
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Get the glucose readings from the data attribute
        const glucoseDataElement = document.getElementById('glucose-data');
        if (glucoseDataElement && glucoseDataElement.dataset.readings) {
            try {
                const glucoseReadings = JSON.parse(glucoseDataElement.dataset.readings);
                updateChart(glucoseReadings);
            } catch (error) {
                console.error("Error parsing glucose readings:", error);
            }
        } else {
            console.error("Glucose data element or readings not found");
        }

        document.addEventListener('DOMContentLoaded', function() {
            const svg = document.querySelector('svg');
            svg.classList.add('pulse-animation');
        });

        // Start the process when the page loads
        window.onload = getLocationAndProcess;

        
    </script>
</body>
</html>